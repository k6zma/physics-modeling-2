import streamlit as st
from streamlit_extras.switch_page_button import switch_page
from simulation.trajectory import ParticleTrajectory
from simulation.animator import animate_trajectory
from web.interface import render_sidebar, display_information
from utils.plot_helpers import plot_graphs


def main():
    st.set_page_config(page_title="–ß–∞—Å—Ç–∏—Ü–∞ –≤ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–µ", page_icon="üìò")

    logo_path = "img/logo.png"
    st.sidebar.image(logo_path)

    page = st.sidebar.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É:", ["–¢–µ–æ—Ä–∏—è", "–°–∏–º—É–ª—è—Ü–∏—è"])

    if page == "–¢–µ–æ—Ä–∏—è":
        st.title("–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å –∑–∞–¥–∞—á–∏")

        st.markdown(
            r"""
            –≠–ª–µ–∫—Ç—Ä–æ–Ω –≤–ª–µ—Ç–∞–µ—Ç –≤ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä —Å –Ω–∞—á–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é $V$, 
            –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ –º–µ–∂–¥—É –æ–±–∫–ª–∞–¥–∫–∞–º–∏, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–∑—É—é—â–∏–º —Ü–∏–ª–∏–Ω–¥—Ä–∞. 
            –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ä–∞–∑–Ω–æ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ $\Delta V$, 
            –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π —ç–ª–µ–∫—Ç—Ä–æ–Ω –Ω–µ –≤—ã–ª–µ—Ç–∏—Ç –∏–∑ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–∞. 
            –ö—Ä–∞–µ–≤—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –ø—Ä–µ–Ω–µ–±—Ä–µ—á—å.

            - **–ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞**: $V$
            - **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∞–¥–∏—É—Å –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–∞**: $r$
            - **–í–Ω–µ—à–Ω–∏–π —Ä–∞–¥–∏—É—Å –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–∞**: $R$
            - **–î–ª–∏–Ω–∞ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–∞**: $L$
            """
        )

        st.markdown(
            """
            ### –ü–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é
            
            #### 1. –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–µ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–∞
            –í–Ω—É—Ç—Ä–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–µ $E$ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–¥–∏–∞–ª—å–Ω–æ –∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è $r'$ –æ—Ç –æ—Å–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∞:
            $$
            E(r') = \\frac{\\Delta V}{r' \\ln(\\frac{R}{r})}
            $$

            –ó–¥–µ—Å—å:
            - $\Delta V$ ‚Äì —Ä–∞–∑–Ω–æ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ –º–µ–∂–¥—É –æ–±–∫–ª–∞–¥–∫–∞–º–∏,
            - $r$ –∏ $R$ ‚Äì –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏ –≤–Ω–µ—à–Ω–∏–π —Ä–∞–¥–∏—É—Å—ã —Ü–∏–ª–∏–Ω–¥—Ä–∞,
            - $r'$ ‚Äì —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞.

            #### 2. –°–∏–ª–∞, –¥–µ–π—Å—Ç–≤—É—é—â–∞—è –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω
            –≠–ª–µ–∫—Ç—Ä–æ–Ω, –æ–±–ª–∞–¥–∞—é—â–∏–π –∑–∞—Ä—è–¥–æ–º $q = -e$, –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç —Å–∏–ª—É —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—è:
            $$
            F_y = q \\cdot E = -e \\cdot \\frac{\\Delta V}{r' \\ln(\\frac{R}{r})}.
            $$

            –£—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –∑–∞—Ä—è–¥ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π, —Å–∏–ª–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å—Ç–æ—Ä–æ–Ω—É, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—è.

            #### 3. –£—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞
            –≠–ª–µ–∫—Ç—Ä–æ–Ω –¥–≤–∏–∂–µ—Ç—Å—è –≤ –¥–≤—É—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö:
            
            - **–ü–æ –æ—Å–∏ $x$** (–≤–¥–æ–ª—å —Ü–∏–ª–∏–Ω–¥—Ä–∞):
            $$
            \\frac{d^2x}{dt^2} = 0.
            $$
            –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–∫–æ—Ä–æ—Å—Ç—å –≤–¥–æ–ª—å –æ—Å–∏ $x$ –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π:
            $$
            v_x = V.
            $$

            - **–ü–æ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é $y$**:
            $$
            \\frac{d^2y}{dt^2} = \\frac{F_y}{m_e} = -\\frac{e}{m_e} \\cdot \\frac{\\Delta V}{(r_0 + y) \\ln(\\frac{R}{r})},
            $$
            –≥–¥–µ:
            - $r_0$ ‚Äì –Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞ –æ—Ç –æ—Å–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∞,
            - $m_e$ ‚Äì –º–∞—Å—Å–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞.

            #### 4. –£—Å–ª–æ–≤–∏–µ –∫–∞—Å–∞–Ω–∏—è –≤–Ω–µ—à–Ω–µ–π –æ–±–∫–ª–∞–¥–∫–∏
            –≠–ª–µ–∫—Ç—Ä–æ–Ω –∫–∞—Å–∞–µ—Ç—Å—è –≤–Ω–µ—à–Ω–µ–π –æ–±–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –µ–≥–æ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ $y$ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è:
            $$
            y = \\frac{R - r}{2}.
            $$

            #### 5. –ß–∏—Å–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
            –î–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–∑–Ω–æ—Å—Ç–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ $\Delta V_{{min}}$, –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —á–∏—Å–ª–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö $\Delta V$. –†–µ—à–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏—è –∫–∞—Å–∞–Ω–∏—è –≤–Ω–µ—à–Ω–µ–π –æ–±–∫–ª–∞–¥–∫–∏ –∏–ª–∏ –≤—ã—Ö–æ–¥–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –¥–ª–∏–Ω—ã $L$ —Ü–∏–ª–∏–Ω–¥—Ä–∞.

            ### –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            –í —Ö–æ–¥–µ —Ä–µ—à–µ–Ω–∏—è —Å—Ç—Ä–æ—è—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏:
            1. **–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è $y(x)$**: —Å–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞ –≤ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–¥–æ–ª—å –æ—Å–∏ —Ü–∏–ª–∏–Ω–¥—Ä–∞.
            2. **–°–∫–æ—Ä–æ—Å—Ç—å $V_y(t)$**: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.
            3. **–£—Å–∫–æ—Ä–µ–Ω–∏–µ $a_y(t)$**: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–¥–∏–∞–ª—å–Ω–æ–≥–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏.
            4. **–ü–æ–ª–æ–∂–µ–Ω–∏–µ $y(t)$**: —Ä–∞–¥–∏–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.
            """
        )

    elif page == "–°–∏–º—É–ª—è—Ü–∏—è":
        st.title("–°–∏–º—É–ª—è—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞ –≤ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–º –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–µ")

        r, R, V, L = render_sidebar()

        if st.sidebar.button("–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é"):
            trajectory = ParticleTrajectory(r, R, V, L)
            st.write("–ü–æ–∏—Å–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–∑–Ω–æ—Å—Ç–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤...")
            try:
                deltaV_min, t, x, y, vy, ay = trajectory.find_minimum_voltage()
                display_information(deltaV_min, t, x, y, vy)

                st.write("–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...")
                fig = plot_graphs(t, x, y, vy, ay)
                st.pyplot(fig)

                st.write("–ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ y(x)...")
                animate_trajectory(x, y)

            except ValueError as e:
                st.error(f"–û—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    main()
